<!DOCTYPE html>
<html lang="en-us">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" ROPCI - So, you think you have MFA? &middot;  Embrace The Red" />
  
  <meta property="og:site_name" content="Embrace The Red" />
  <meta property="og:url" content="https://embracethered.com/blog/posts/2022/ropci-so-you-think-you-have-mfa-azure-ad/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2022-09-25T10:30:29-07:00" />
  
  <meta property="og:article:tag" content="pentest" />
  
  <meta property="og:article:tag" content="red" />
  
  <meta property="og:article:tag" content="research" />
  
  <meta property="og:article:tag" content="cloud" />
  
  <meta property="og:article:tag" content="tool" />
  
  

  <title>
     ROPCI - So, you think you have MFA? &middot;  Embrace The Red
  </title>

  <link rel="stylesheet" href="https://embracethered.com/blog/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/main.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://embracethered.com/blog/css/github.css" />
  
  <link rel="stylesheet" href="https://embracethered.com/blog/fonts/cachedfonts.css" type="text/css">
  <link rel="shortcut icon" href="https://embracethered.com/blog/images/favicon.ico" />
  <link rel="apple-touch-icon" href="https://embracethered.com/blog/images/apple-touch-icon.png" />
  

  
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@wunderwuzzi23">
<meta name="twitter:title" content="ropci - So, you think you have MFA?">
<meta name="twitter:description" content="Abusing ROPC to identify MFA bypass opportunities in Microsoft AAD. Test your own tenant!">
<meta name="twitter:image" content="https://embracethered.com/blog/images/2022/ropci.png">

<meta name="twitter:creator" content="@wunderwuzzi23">




  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1739327806831586"
  crossorigin="anonymous"></script>
  
</head>
<body>
    <header class="global-header"  style="background-image:url( /blog/images/bg.png )">
    <section class="header-text">
      <h1><a href="https://embracethered.com/blog/">Embrace The Red</a></h1>
      
      <div class="tag-line" style="min-width:fit-content; font-weight: 400;">
        wunderwuzzi&#39;s blog
        <br><a style="color: greenyellow; font-weight:300;text-decoration: underline; " href="https://www.amazon.com/gp/product/1838828869/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1838828869&linkCode=as2&tag=wunderwuzzi-20&linkId=b6523e937607be47499c6010ff489537">OUT NOW: Cybersecurity Attacks - Red Team Strategies</a> 
      </div>
      
      <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>

      
      <a href="https://embracethered.com/blog/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left" aria-hidden="true"></i>
        &nbsp;Home
      </a>
      
    
      <a href="/blog/index.xml" class="btn-header btn-subscribe hidden-xs">
        <i class="fa fa-rss" aria-hidden="true"></i>
        &nbsp;Subscribe
      </a>
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">ROPCI - So, you think you have MFA?</h1>
    <div class="post-meta clearfix">
    
      <div class="post-date pull-left">
        Posted on
        <time datetime="2022-09-25T10:30:29-07:00">
          Sep 25, 2022
        </time>
      </div>
    
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/pentest">#pentest</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/red">#red</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/research">#research</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/cloud">#cloud</a></span>
        
        <span class="post-tag small"><a href="https://embracethered.com/blog//tags/tool">#tool</a></span>
        
      </div>
    </div>
  </header>
  <section>
    <p>This post will highlight systemic pattern I have seen across multiple production Microsoft Azure Active Directory tenants which led to MFA bypasses using ROPC.</p>
<p><strong>The key take-away upfront: Test your own Microsoft AAD tenant for ROPC based MFA bypasses. It is not unlikely that your tenant is vulnerable. 3/3 production tests (of fairley large companies) I did succeeded and every company believed that MFA was setup and enforced correctly!</strong></p>
<p><img src="/blog/images/2022/ropci.png" alt="How does an OAuth2 ROPC Request look like"></p>
<h1 id="what-is-ropc">What is ROPC?</h1>
<p><code>Resource Owner Password Credentials</code> (ROPC) is an OAuth2 authorization grant type (“flow”) defined in <a href="https://www.rfc-editor.org/rfc/rfc6749.html">RFC 6749</a>.</p>
<p>It uses <code>username</code> and <code>password</code> directly to obtain an access token.</p>
<p><strong>This is problematic because:</strong></p>
<ul>
<li>The client process sees the user&rsquo;s password.</li>
<li>It maintains the password &ldquo;anti-pattern&rdquo; that OAuth2 otherwise solves.</li>
</ul>
<p>The reason it exists is to support a smoother migration from legacy applications to OAuth2.</p>
<p>Microsoft highlights this in their documentation:</p>
<p><img src="/blog/images/2022/ropci-legacy.png" alt="Microsoft ROPC Legacy"></p>
<p>And <a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#page-9">OAuth 2.0 Security Best Current Practice</a> states it even more clearly:</p>
<p><img src="/blog/images/2022/rfc-legacy.png" alt="RFC ROPC Legacy"></p>
<p>So, the take-away is: <strong>ROPC MUST NOT be used</strong></p>
<p>If you are using Conditional Access Policy, be aware that the &ldquo;Block legacy authentication&rdquo; CAS template does not block ROPC!</p>
<p>Wait, but what is this ROPC and am I using it?</p>
<h1 id="how-does-the-ropc-flow-look-like">How does the ROPC flow look like?</h1>
<p>At a high level the <code>grant_type</code> in the OAuth2 POST request to the token endpoint will contain this parameter:</p>
<pre><code>grant_type=password
</code></pre><p>This highlights the <code>resource owner password credentials</code> flow.</p>
<p>A complete <code>ROPC</code> request looks as follows:</p>
<p><img src="/blog/images/2022/ropc-post.png" alt="How does an OAuth2 ROPC Request look like"></p>
<p>As can be seen, the request contains <code>username/password</code> and the <code>client_id</code>.</p>
<p>Microsoft refers to <code>client_id</code> often as <code>appID</code> in their internal documentation and UI. There is no <code>client_secret</code> with these appIDs they are called public clients.</p>
<p>If authentication succeeds, the response will contain an <code>access_token</code> amongst other information:</p>
<p><img src="/blog/images/2022/ropc-response.png" alt="How does an OAuth2 ROPC Response look like"></p>
<h2 id="wait-i-dont-have-ropc-oauth-apps-in-my-aad-tenant">Wait, I don&rsquo;t have ROPC OAuth apps in my AAD tenant!</h2>
<p>AAD ships 50+ applications by default that support ROPC and are active in every tenant.</p>
<p>Here are a few examples:
<a href="/blog/images/2022/ropc-apps-msft-by-default.png"><img src="/blog/images/2022/ropc-apps-msft-by-default.png" alt="How does an OAuth2 ROPC Request look like"></a></p>
<p>Combined the various applications have permissions such as reading AAD info (users, groups, permissions), reading/sending emails, accessing Azure, access and uploading information to SharePoint, etc.</p>
<p>So, what do I do with this info now?</p>
<h1 id="from-an-offensive-security-perspective-the-following-questions-are-interesting">From an offensive security perspective, the following questions are interesting:</h1>
<ul>
<li>How to test for ROPC exposure?</li>
<li>What kind of tests to run?</li>
<li>What questions to ask or AD admins?</li>
</ul>
<h1 id="introducing-ropci">Introducing ropci</h1>
<p>To aid with testing I wrote <code>./ropci</code> which is a Microsoft AAD ROPC OAuth2 assessment tool.</p>
<p>You can download the code from Github: <a href="https://github.com/wunderwuzzi23/ropci">ropci</a></p>
<p><img src="/blog/images/2022/ropci-options.png" alt="ropci tool - Microsoft Azure AAD OAuth2 Assessment Tool"></p>
<p>I will do another post to highlight it&rsquo;s usage more clearly, but if you go over to the github it should have everything needed to get you started!</p>
<h1 id="ropc-mfa-bypass-opportunities">ROPC MFA Bypass Opportunities</h1>
<p>There are four ROPC MFA bypass opportunities:</p>
<ol>
<li><a href="#securitydefaults">Security defaults and Disabled MFA Status</a></li>
<li><a href="#hybrid">Hybrid and federated identity setups</a></li>
<li><a href="#serviceaccounts">Service accounts</a></li>
<li><a href="#apt29">14-day grace period for MFA activation</a></li>
</ol>
<h2 id="securitydefaults">Opportunity #1 - Security Defaults and Disabled MFA Status</h2>
<p>Security defaults is a great feature that aims to lock down AAD tenants with single configuration change, it&rsquo;s also the default for newly created tenants now.</p>
<p>However, Microsoft&rsquo;s <a href="https://docs.microsoft.com/en-us/azure/active-directory/fundamentals/concept-fundamentals-security-defaults#require-all-users-to-register-for-azure-ad-multi-factor-authentication">documentation</a> incorrectly states that:</p>
<blockquote>
<p>&ldquo;&hellip;don&rsquo;t be alarmed to not see users in an <strong>Enabled</strong> or <strong>Enforced</strong> status if you look at the MFA status page. <strong>Disabled</strong> is the appropriate status for users who are using security defaults&hellip;&rdquo;</p>
</blockquote>
<p>Here is a screenshot of the description:</p>
<p><img src="/blog/images/2022/ropc-disabled-status.png" alt="ROPC Disabled MFA"></p>
<p>The unfortunate result with this advice is that it allows to get around MFA (e.g even ROPC attacks from VPN connections from other countriese, e.g. impossible travels). The only thing I found to mitigate this entirely is to explicitly enforce MFA per-user, regardless of what the documentation says.</p>
<h3 id="mitigation">Mitigation:</h3>
<p>Make sure to go into your tenant settings, turn on security defaults and also enforce per-user MFA for every user!</p>
<h2 id="hybrid">Opportunity #2 - Hybrid and Federated Scenarios</h2>
<p>When federation is setup, a federated identity provider (e.g. ADFS or Okta,&hellip;) will perform the MFA check.</p>
<p>But, what if you have <strong>native AAD only accounts?</strong></p>
<p>Bad news, they can be called via single-factor ROPC calls unless MFA is enforced explicitly at the AAD layer. It&rsquo;s a common misconfiguration and oversight in my experience and testing so far.</p>
<p>To get a list of interesting accounts you could use ropci (or the Azure portal or some other tool):</p>
<pre><code>ropci` can help you identify such accounts by quering your AAD for 
`./ropci users list --format-csv | jq -r '.value[] | select (.onPremisesImmutableId == null and .accountEnabled == true and userType != &quot;Guest&quot; | .userPrincipalName)
</code></pre><p>There are other properties, such as <code>.onPremisesSyncEnabled</code> that are interesting to look at. You might see that the onPremisesSync is disabled, but accounts still have an active account in AAD. This might mean that AAD still has the password hash stored and won&rsquo;t need to-do pass through authentication. Lots of opportunities for further testing here.</p>
<p>There are also sometimes older accounts that have an empty <code>userType</code>, so make sure to not only look for <code>.userType == &quot;Member&quot;</code> as you might miss accounts that way.</p>
<p>At times you might even find accounts that are deleted in the on-premises AD, but still exist in AAD. Yes.</p>
<p>If you are testing a large directory dump the <code>users list</code> first into a file, that makes it easier to analyze later.</p>
<h3 id="mitigation-1">Mitigation:</h3>
<p>Review your tenant for pure/native AAD accounts and ensure MFA is enforced for them.</p>
<h2 id="serviceaccounts">Opportunity #3 - Service Accounts</h2>
<p>Well, these always exist in companies, and they will not have MFA enabled. Hopefully other mitigations are put in place, such as IP allow-listing and better using the proper OAuth2 flows.</p>
<h3 id="mitigation-2">Mitigation:</h3>
<p>Figure out what service accounts exists. Ensure they are monitored and there is a path to locking things down via IP allow-listing and leveraging other flows such as <code>client_credentials</code> with certificates.</p>
<h2 id="opportunity-4---14-day-mfa-grace-period-for-mfa-activation">Opportunity #4 - 14-day MFA grace period for MFA activation</h2>
<p><a href="https://www.zdnet.com/article/hackers-are-using-this-sneaky-trick-to-exploit-dormant-microsoft-cloud-accounts-and-bypass-multi-factor-authentication/">ZDNET</a> and <a href="https://www.mandiant.com/resources/blog/apt29-continues-targeting-microsoft">Mandiant</a> recently reported that APT29 is exploiting this behavior.</p>
<p>I added this bypass opportunity as it&rsquo;s out in the wild. One can use ROPC to bruteforce credentials and there will be a different error code if the password was guessed correctly.</p>
<p>However, to get an access token a manual login needs to be performed by an attacker. The reason a manual logon is required is that tyipcally the user needs to change the password on first login, which the ROPC flow does not support.</p>
<h1 id="go-do-test-ropc-scenarios">Go-do: Test ROPC scenarios!</h1>
<p>Now that we reviewed a couple of ROPC bypass opportunties what can be done? What should be validated to make sure MFA is correctly configured?</p>
<p>Test your own tenant for these attacks to make sure an adversary can&rsquo;t exploit them:</p>
<h3 id="attempt-ropc-logons-using">Attempt ROPC logons using</h3>
<ol>
<li>Your own user account</li>
<li>Service accounts</li>
<li>AAD only accounts</li>
</ol>
<p>You can use, e.g. <code>./ropci auth logon -u account@example.org -P</code> to quickly perform such tests.</p>
<h3 id="identify-applications-that-support-ropc-the-offsec-way">Identify applications that support ROPC (the offsec way)</h3>
<ol>
<li><code>./ropci apps list</code>: Enumerate all OAuth apps in your tenant</li>
<li><code>./ropci auth bulk</code>: Test all apps, and review results and granted scopes</li>
</ol>
<h3 id="ropc-password-sprays">ROPC Password Sprays</h3>
<ol>
<li>An adversary can use ROPC to perform a password spray (<code>./ropci auth spray</code>)</li>
</ol>
<h1 id="take-aways-for-ropc">Take-aways for ROPC</h1>
<ul>
<li>Always explicitly enforce MFA!</li>
<li>Security defaults might not adequately protect.</li>
<li>Hybrid and federated MFA enforcement can leave &ldquo;native&rdquo; AAD accounts vulnerable (think of them as accounts folks forget about)</li>
<li>Test and validate your configurations from an offsec point of view!</li>
<li>Some scenarios might remain vulnerable to SFA  =&gt; <strong>These should be a known and conscious decisions (risk acceptance)</strong></li>
<li>Know your weaknesses, monitor exposure, and continue mitigating and locking down exposures</li>
</ul>
<p>知己知彼,百戰百勝.</p>
<h1 id="related-research-and-tools">Related Research and Tools</h1>
<p>A lot of great research and tooling out there, e.g.:</p>
<ul>
<li><a href="https://o365blog.com/aadinternals/">AADInternals by @DrAzureAD</a></li>
<li><a href="https://github.com/secureworks/family-of-client-ids-research">&ldquo;Abusing Family Refresh Tokens&rdquo; by SecureWorks</a></li>
<li>ROADTools and more recently TeamFiltration,&hellip;</li>
</ul>
<h1 id="references">References</h1>
<ul>
<li><a href="https://www.rfc-editor.org/rfc/rfc6749.html">OAuth RFC</a></li>
<li><a href="https://o365blog.com/aadinternals/">AAD Internals</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics#page-9">OAuth 2.0 Security Best Current Practice</a></li>
<li>[Hackers are using this sneaky exploit to bypass Microsoft&rsquo;s MFA)(https://www.zdnet.com/article/hackers-are-using-this-sneaky-trick-to-exploit-dormant-microsoft-cloud-accounts-and-bypass-multi-factor-authentication/)</li>
</ul>

  </section>
  <footer>
    
    
    
    <footer></footer><hr/>
    
    <ul class="pager">
      
      <li class="next disabled"><a href="#">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
      
      <li class="author-contact">
        <a href="mailto:security@wunderwuzzi.net">
          <i class="fa fa-envelope-o" aria-hidden="true"></i>
          &nbsp;Contact me
        </a>
     </li>

      
      
      <li class="previous"><a href="https://embracethered.com/blog/posts/2022/gospray-active-directory-ldap-password-spraying/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
    </ul>
  </footer>
</article>
</main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
     
     (c) WUNDERWUZZI 2018-2022
     <div class="sns-links hidden-print">
  
  <a href="mailto:security@wunderwuzzi.net">
    <i class="fa fa-envelope"></i>
  </a>
  
  
  <a href="https://twitter.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/wunderwuzzi23" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  
  
  
  
  <a href="/blog/index.xml" target="_blank">
    <i class="fa fa-rss"></i>
  </a>
</div>
 
     <div style="font-size:small;font-style: italic;color:crimson">
    Disclaimer: Penetration testing requires authorization from proper stakeholders. Information on this blog is provided for research and educational purposes to advance understanding of attacks and countermeasures to help secure the Internet. 
    </div>
    </div>
</footer>
  <script src="https://embracethered.com/blog/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  



<script type="text/javascript">
  var _paq = window._paq || [];
  _paq.push(["disableCookies"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//wuzzi.net/anamato/inc/";
    _paq.push(['setTrackerUrl', u+'rts.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'rts.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<img src="https://wuzzi.net/anamato/inc/rts.php?idsite=1&amp;rec=1" style="border:0;" alt="" />
  
</body>
</html>

